C51 COMPILER V9.52.0.0   SYSTEM                                                            06/02/2018 13:38:49 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN system.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE system.c LARGE OPTIMIZE(6,SPEED) BROWSE INCDIR(G:\CB589P) DEBUG OBJECTEXTEN
                    -D TABS(2)

line level    source

   1          
   2          #include "system.h"
   3          
   4          /***************************************ÐÞ¸Ä¼ÇÂ¼*****************************************************
   5          Function List£º
   6            1¡¢systemCLK_init       ÏµÍ³Ê±ÖÓÉèÖÃ  ÓÃÄÚ²¿Ê±ÖÓ4MHz
   7            2¡¢initTimer0           Timer0³õÊ¹»¯
   8            3¡¢IO_Init              IO¿Ú³õÊ¹»¯
   9            4¡¢delayms              1msÑÓÊ±º¯Êý
  10            5¡¢delayus              Ò»¸öÊ±ÖÓ 16us ÑÓÊ±º¯Êý
  11            6¡¢UART0_Init           ´®¿ÚÖÐ¶Ï³õÊ¹»¯
  12            7¡¢LCD_Init             LCD³õÊ¹»¯
  13            8¡¢Get_AD               µçÑ¹¼ì²âº¯Êý
  14          Change Log:
  15          
  16          
  17          
  18          ****************************************************************************************************/
  19          
  20          xdata tCbParam mCbParam;
  21          xdata tSqParam mSqParam;
  22          xdata tSysParam mSysParam;
  23          xdata tTimer   mTimer;
  24          xdata tReceivePackage mReceivePackage;
  25          xdata tVoltageSend mVoltageSend;
  26          xdata tMenu mMenu;
  27          
  28          /*´®¿Ú½ÓÊÕ*/
  29          uchar mUartCmd = 0;
  30          
  31          
  32          /*-------------------------------------------------------------------------
  33          *º¯Êý£ºsystemCLK_init  ÏµÍ³Ê±ÖÓÑ¡Ôñ  Íâ²¿16MÊ±ÖÓ
  34          *²ÎÊý£ºÎÞ  
  35          *·µ»ØÖµ£ºÎÞ
  36          *-------------------------------------------------------------------------*/
  37          void systemCLK_init()
  38          {
  39   1        WPKEY = 0x37;
  40   1        CLKEN |= 0x25;                  // ´ò¿ªRCH   P9.2 P9.3×÷ÎªÆÕÍ¨IO¿Ú<5>
  41   1        while((MCKSEL&0x08) != 0x08);   // ²é¿´RCHÎÈ¶¨±êÖ¾Î»ÊÇ·ñÖÃÆð
  42   1        WPKEY  = 0x37;
  43   1        MCKSEL &= 0xF8;                // ÇÐ»»µ½RCH
  44   1        WPKEY = 0x37;
  45   1        MCKDIV = 0x03;  //²»·ÖÆµ
  46   1        WPKEY = 0x37;
  47   1        xSYSCFG|=0x30;                //¿ªÆôRCTÊ±ÖÓÓÃÓÚLCD
  48   1      
  49   1      }
  50          /*-------------------------------------------------------------------------
  51          *º¯Êý£ºinitTimer0  ¶¨Ê±Æ÷³õÊ¹»¯  16ms¶¨Ê±Æ÷
  52          *²ÎÊý£ºÎÞ  
  53          *·µ»ØÖµ£ºÎÞ
  54          *-------------------------------------------------------------------------*/
C51 COMPILER V9.52.0.0   SYSTEM                                                            06/02/2018 13:38:49 PAGE 2   

  55          void initTimer0(void) //¶¨Ê±16ms
  56          {
  57   1        TMOD   = 0X03;          //Ä£Ê½3,2¸ö¶ÀÁ¢µÄ8Î»¼ÆÊýÆ÷
  58   1          xTIMPRS= 0X07;              //¶¨Ê±Æ÷·ÖÆµ±ÈÉèÎª256
  59   1          TH0    = 6;                  
  60   1          TCON   = 0X10;          //Æô¶¯¶¨Ê±Æ÷0
  61   1          EA     = 1;
  62   1          ET1=1;                          //Ê¹ÄÜT1ÖÐ¶Ï
  63   1          TR1=0;                          //Æô¶¯¶¨Ê±Ê±1
  64   1        /*
  65   1          //³õÊ¼»¯¶¨Ê±Æ÷
  66   1          xTIMPRS |= 0x07;  //t0: MCLK/256 = 4M/256 = 15625Hz
  67   1        TMOD |= 0x01; //t0: 16Î»¶¨Ê±Æ÷
  68   1        TH0 = (65535 - 781) / 256;  
  69   1        TL0 = (65535 - 781) % 256;  //50ms => 0.05S * 15625 = 781 
  70   1        TR0 = 1;
  71   1        ET0 = 1;
  72   1        */
  73   1      }
  74          /*-------------------------------------------------------------------------
  75          *º¯Êý£ºIO_Init  IO¿Ú³õÊ¹»¯  
  76          *²ÎÊý£ºÎÞ  
  77          *·µ»ØÖµ£ºÎÞ
  78          *-------------------------------------------------------------------------*/
  79          void IO_Init()
  80          {
  81   1        P0MDL=0xAA;                  //LCD¿ØÖÆ
  82   1        P0MDH=0xAA;                  //LCD¿ØÖÆ
  83   1        //P0=0;
  84   1      
  85   1        
  86   1        
  87   1        P1MDL=0xAA;                 //0£º4802TRX  1£ºA/F_EN  2£ºGREEN  3£ºCE  
  88   1        P1MDH=0xAA;                 //4£º4W 5£º 1W  6£ºRED  7SCL
  89   1        P1=0x20;
  90   1        
  91   1        
  92   1        P2MDL=0xA1;                 //0£ºTXD/PPT£¨ÉÏÀ­£©  1:RXD/VOX  2:LIGHT_G  3:BEEP  
  93   1        P2MDH=0x82;                  //4:LIGHT_R  5..  6.. 7:MODDA
  94   1      
  95   1      
  96   1        
  97   1        P3MDH=0xAA;                 //COM0-3  
  98   1        
  99   1        xP4MDL=0xAA;                //0:SEG8  1£ºLIGHT_B  2:AM_EN  3£ºMIC_MUTE  
 100   1        xP4MDH=0xAA;                //4:AT_MUTE  5:FM_EN  6£º4802 SCK  7:4802 24C08 SDA
 101   1        SET_AT_MUTE;
 102   1      
 103   1        
 104   1        
 105   1        xADCFG=0x10;                  //ADC¶ÔÆë·½Ê½Îª  µÍ4Î»ADRL ¸ß2Î»ADRH 
 106   1        
 107   1        xP9AEN&=0x03;                 //P9.2  P9.3×÷ÎªGPIO¶Ë¿Ú
 108   1        xP9AEN|=0x03;
 109   1        xP9MDL=0x00;                 //P9.2  P9.3×÷ÎªÊäÈë
 110   1        
 111   1        
 112   1        
 113   1        SET_BK4802_SCK;
 114   1        SET_BK4802_SDA;
 115   1        
 116   1        
C51 COMPILER V9.52.0.0   SYSTEM                                                            06/02/2018 13:38:49 PAGE 3   

 117   1      }
 118          
 119          
 120          
 121          /*-------------------------------------------------------------------------
 122          *º¯Êý£ºdelayms  ÑÓÊ±1ms   
 123          *²ÎÊý£ºÎÞ  
 124          *·µ»ØÖµ£ºÎÞ
 125          *-------------------------------------------------------------------------*/
 126          void delayms(unsigned int i)
 127          {
 128   1        unsigned int m,n;
 129   1        
 130   1        for(m=0;m<i;m++)
 131   1        {
 132   2          for(n=0;n<208;n++);
 133   2        }
 134   1      }
 135          /*-------------------------------------------------------------------------
 136          *º¯Êý£ºdelayus  ÑÓÊ±6.5us×óÓÒ 
 137          *²ÎÊý£ºÎÞ  
 138          *·µ»ØÖµ£ºÎÞ
 139          *-------------------------------------------------------------------------*/
 140          void delayus(u8 i)
 141          {
 142   1          while(--i);
 143   1      }
 144          /*-------------------------------------------------------------------------
 145          *º¯Êý£ºinitBEEP  PWM  BEEPÒô³õÊ¹»¯ 
 146          *²ÎÊý£ºÎÞ  
 147          *·µ»ØÖµ£ºÎÞ
 148          *-------------------------------------------------------------------------*/
 149          void initBEEP(void)
 150          { 
 151   1        xSYSCFG |= 0x20;
 152   1        xPWMPSC|=0x16;          //PWMÔ¤·ÖÆµ±È20
 153   1        xIOMUX0 |= 0x02;//En P23 as Pwm0
 154   1        xPWMP = 0Xad; //ÖÜÆÚ
 155   1        xPWM0D = 0X50;  //Õ¼¿Õ±È£¬modda
 156   1        P2MDL &= 0x3f;
 157   1        P2MDL |= 0x80;
 158   1      }
 159          /*-------------------------------------------------------------------------
 160          *º¯Êý£ºUART0_Init  ´®¿Ú³õÊ¹»¯
 161          *²ÎÊý£ºÎÞ  
 162          *·µ»ØÖµ£ºÎÞ
 163          *-------------------------------------------------------------------------*/
 164          void UART0_Init()
 165          {
 166   1        xIOMUX0 |= 0x01;        //P21/P20¸´ÓÃ×öUART0¶Ë¿Ú
 167   1        SCON0=0x50;             //¹¤×÷Ä£Ê½1,8Î»Òì²½£¬²¨ÌØÂÊ¿Éµ÷ ÔÊÐí½ÓÊÕÓë·¢ËÍ
 168   1        BRCON0  = 0x68;         //²¨ÌØÂÊ¼ÆËã¹«Ê½Îª1/32£¨2smod=1£©,²¨ÌØÂÊ·¢ÉúÆ÷¿ªÆô£¬¸ß¾«¶È²¨ÌØÂÊ¿ØÖÆÊ¹ÄÜ
 169   1        SBUF0=0;
 170   1        BRTIM0  = 242;          //
 171   1        IE |=0X10;        //¿ª´®¿ÚÖÐ¶Ï     
 172   1      }
 173          /*
 174          void UART1_Init()
 175          {
 176            xIOMUX2 |= 0x01;        //P24/P23¸´ÓÃ×öUART1¶Ë¿Ú
 177            SCON1 |= 0x50;         //¹¤×÷Ä£Ê½1,8Î»Òì²½£¬²¨ÌØÂÊ¿Éµ÷ Ê¹ÄÜ½ÓÊÕ
 178           
C51 COMPILER V9.52.0.0   SYSTEM                                                            06/02/2018 13:38:49 PAGE 4   

 179            xBRCON1  = 0XE8;//0x68;         //²¨ÌØÂÊ¼ÆËã¹«Ê½Îª1/16£¨2smod=1£©£¬²¨ÌØÂÊ·¢ÉúÆ÷¿ªÆô£¬¸ß¾«¶È²¨ÌØÂÊ¿ØÖÆÊ¹Ä
             -Ü   
 180            xBRTIM1  = 0x98;
 181            EIE2 |=0X10;                    //Ê¹ÄÜES1ÖÐ¶Ï
 182          }
 183          */
 184          
 185          void INT1_Init(void)
 186          {
 187   1          EA = 0;
 188   1          xIOMUX2 &= 0xDF;                  //INT½ÅÑ¡P01
 189   1          IT1 = 1;                          //¸º±ßÑØ£¨ÏÂ½µÑØ£©´¥·¢ÖÐ¶Ï
 190   1          EINTCS0 = 0xA0;                   //bit5=1£¬INT1ÖÐ¶ÏÊ¹ÄÜÐÅºÅ ,Òì²½ÖÐ¶ÏÄ£Ê½
 191   1          IE1 = 0;                          //ÇåINT1ÏÂ½µÑØÖÐ¶Ï±êÖ¾
 192   1          EINTCS0 &= 0xfc;                  //Çå³ý±êÖ¾ £¬Ë«»º³å»úÖÆµÄÖÐ¶Ï£¬2´ÎÇå³ý±êÖ¾
 193   1          EINTCS0 &= 0xfc;                  //Çå³ý±êÖ¾
 194   1          
 195   1      }
 196          void LCD_Init(void)
 197          {
 198   1        WPKEY = 0x37;
 199   1        RTCSEL = 0x04;
 200   1        RTCDATA|=0x01;
 201   1        xLCDPEN1 = 0xff;      //P00-P07¸´ÓÃÎªLCD SEG
 202   1        xLCDPEN0 = 0x0f;      //P34-P37¸´ÓÃÎªLCD COM
 203   1        xLCDPEN2 = 0x01;      //P40¸´ÓÃÎªLCD SEG  
 204   1        xLCDCON  = 0x97;       //bit0 1:ËÄ¸öCOM¿Ú   bit2:Æ«ÖÃ1/3 4µçÆ½  bit4 5:LCDÉ¨ÃèÆµÂÊÎª256HZ  bit7:LCDÄ£¿é¿ª
             -Æô
 205   1      
 206   1        //xTKADDR0=0;
 207   1        //TKCON=£¿  TKADDR=? ÉÁË¸¿ØÖÆ
 208   1        xLCDPCON=0x82;       //
 209   1      }
 210          
 211          
 212          void SystemInit()
 213          {
 214   1        systemCLK_init();
 215   1        IO_Init();  
 216   1        initTimer0();
 217   1        UART0_Init();
 218   1        LCD_Init();
 219   1        //UART1_Init();
 220   1        initBEEP(); 
 221   1        EA=1;
 222   1        //INT1_Init();
 223   1        //UART1_Init();
 224   1      }
 225          
 226          u16 Get_AD(u8 AD_IO)
 227          {
 228   1        u16 i,j;
 229   1        u32 temp;
 230   1        u16 val[10];
 231   1        
 232   1        switch(AD_IO) 
 233   1        {   
 234   2          case ADC_ASQ:           //P30
 235   2            xP3AEN=0x01;  
 236   2            ADCON=0x08;
 237   2            break;
 238   2          case ADC_Key1:
C51 COMPILER V9.52.0.0   SYSTEM                                                            06/02/2018 13:38:49 PAGE 5   

 239   2            xP9AEN=0x01;         //P90
 240   2            ADCON=0x48;
 241   2            break;
 242   2          case ADC_VOX:          //P91
 243   2            xP9AEN=0x02;         
 244   2            ADCON=0x58;
 245   2            break;
 246   2          case ADC_RSSI:          //P32
 247   2            xP3AEN=0x04;  
 248   2            ADCON=0x28;
 249   2            break;
 250   2          case ADC_AGCA:          //P33
 251   2            xP3AEN=0x08;  
 252   2            ADCON=0x38;
 253   2            break;
 254   2          default:
 255   2            break;
 256   2        }
 257   1        
 258   1        delayus(10);
 259   1        for(i=0;i<10;i++)
 260   1        {
 261   2          ADGO=1;
 262   2          while(ADGO==1);
 263   2          val[i]=((ADRH<<8)|ADRL);
 264   2        }
 265   1        for(i=0;i<10;i++)   
 266   1        {
 267   2          for(j=0;j<10-i;j++)
 268   2          {
 269   3            if(val[j]>val[j+1])
 270   3            { 
 271   4              temp = val[j];      
 272   4              val[j] = val[j+1];
 273   4              val[j+1] = temp;                 
 274   4            }
 275   3          }
 276   2        }
 277   1        temp=0;
 278   1        for(i=3;i<6;i++)  
 279   1        {
 280   2          temp+=val[i];
 281   2        }
 282   1        temp=temp/3;
 283   1        return temp;
 284   1      }
 285          
 286          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    827    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    152      26
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
